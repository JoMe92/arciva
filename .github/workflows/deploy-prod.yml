name: Deploy to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'GHCR image tag (defaults to latest).'
        required: false

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Production rollout
    runs-on: ubuntu-latest
    timeout-minutes: 45
    environment:
      name: production
      url: ${{ secrets.PROD_URL }}
    env:
      IMAGE_NAME_BASE: ghcr.io/${{ github.repository_owner }}/arciva-frontend
      PROD_URL: ${{ secrets.PROD_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Require production URL
        run: |
          if [ -z "${PROD_URL:-}" ]; then
            echo "PROD_URL must be configured for production deployments" >&2
            exit 1
          fi

      - name: Determine image tag
        id: image-tag
        run: |
          tag="${{ github.event.inputs.image_tag }}"
          if [ -z "$tag" ]; then
            tag="${IMAGE_NAME_BASE}:latest"
          fi
          echo "image_tag=$tag" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull image for verification
        id: image-digest
        run: |
          docker pull "${{ steps.image-tag.outputs.image_tag }}"
          digest=$(docker inspect --format='{{index .RepoDigests 0}}' "${{ steps.image-tag.outputs.image_tag }}")
          if [ -z "$digest" ]; then
            digest=$(docker inspect --format='{{.Id}}' "${{ steps.image-tag.outputs.image_tag }}")
          fi
          echo "image_digest=$digest" >> "$GITHUB_OUTPUT"

      - name: Canary rollout (10% traffic)
        run: |
          echo "Deploying canary of ${{ steps.image-tag.outputs.image_tag }} to 10% of production traffic"
          echo "Replace this step with your orchestrator hook or API call."

      - name: Canary smoke test
        run: |
          set -euo pipefail
          target="${PROD_URL%/}/health"
          curl --fail --retry 3 --retry-delay 5 --max-time 10 "$target"

      - name: Promote to global deployment
        run: |
          echo "Promoting ${{ steps.image-tag.outputs.image_tag }} to full production following canary validation"

      - name: Production smoke test
        run: |
          set -euo pipefail
          target="${PROD_URL%/}/health"
          curl --fail --retry 3 --retry-delay 5 --max-time 10 "$target"

      - name: Deployment summary and rollback guidance
        run: |
          echo "Image: ${{ steps.image-tag.outputs.image_tag }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Digest: ${{ steps.image-digest.outputs.image_digest }}" >> "$GITHUB_STEP_SUMMARY"
          echo "URL: $PROD_URL" >> "$GITHUB_STEP_SUMMARY"
          echo "Rollback: rerun this workflow with the desired image_tag (e.g., previous digest) or tag." >> "$GITHUB_STEP_SUMMARY"
