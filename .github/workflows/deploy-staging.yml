name: Deploy to Staging

on:
  workflow_run:
    workflows: ["Docker Build & Publish"]
    types: [completed]
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    name: Deploy staging image
    if: github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main')
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: ${{ secrets.STAGING_URL }}
    timeout-minutes: 30
    env:
      IMAGE_NAME_BASE: ghcr.io/${{ github.repository_owner }}/arciva-frontend
      STAGING_URL: ${{ secrets.STAGING_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Require staging URL
        run: |
          if [ -z "${STAGING_URL:-}" ]; then
            echo "STAGING_URL must be configured for staging deployments" >&2
            exit 1
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Capture image reference
        id: image-ref
        run: |
          echo "image_ref=${IMAGE_NAME_BASE}:latest" >> "$GITHUB_OUTPUT"

      - name: Pull latest image for digest
        id: image-digest
        run: |
          docker pull ${{ steps.image-ref.outputs.image_ref }}
          digest=$(docker inspect --format='{{index .RepoDigests 0}}' ${{ steps.image-ref.outputs.image_ref }})
          if [ -z "$digest" ]; then
            digest=$(docker inspect --format='{{.Id}}' ${{ steps.image-ref.outputs.image_ref }})
          fi
          echo "image_digest=$digest" >> "$GITHUB_OUTPUT"

      - name: Deploy to staging
        run: |
          echo "Deploying ${{ steps.image-ref.outputs.image_ref }} (digest: ${{ steps.image-digest.outputs.image_digest }})"
          echo "Replace this step with your staging deployment mechanism."

      - name: Run smoke tests
        run: |
          set -euo pipefail
          target="${STAGING_URL%/}/health"
          curl --fail --retry 3 --retry-delay 5 --max-time 10 "$target" -o /tmp/staging-health

      - name: Post-deploy summary
        run: |
          echo "Image: ${{ steps.image-ref.outputs.image_ref }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Digest: ${{ steps.image-digest.outputs.image_digest }}" >> "$GITHUB_STEP_SUMMARY"
          echo "URL: $STAGING_URL" >> "$GITHUB_STEP_SUMMARY"
