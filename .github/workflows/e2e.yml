name: E2E Suite

on:
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '30 2 * * *'

permissions:
  contents: read

jobs:
  happy-path:
    name: Happy path UI tests
    runs-on: ubuntu-latest
    env:
      PREVIEW_URL: ${{ secrets.PREVIEW_URL }}
      PREVIEW_URL_TEMPLATE: ${{ secrets.PREVIEW_URL_TEMPLATE }}
      STAGING_URL: ${{ secrets.STAGING_URL }}
      PR_NUMBER: ${{ github.event.number }}
      BRANCH: ${{ github.head_ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve target URL
        id: target
        run: |
          set -euo pipefail
          target=""
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            if [ -n "${PREVIEW_URL_TEMPLATE:-}" ]; then
              target=$(python - <<'PY'
          import os
          template = os.environ["PREVIEW_URL_TEMPLATE"]
          template = template.replace("{{PR_NUMBER}}", os.environ.get("PR_NUMBER", ""))
          template = template.replace("{{BRANCH}}", os.environ.get("BRANCH", ""))
          print(template)
          PY
          )
            elif [ -n "${PREVIEW_URL:-}" ]; then
              target="${PREVIEW_URL}"
            else
              echo "PREVIEW_URL or PREVIEW_URL_TEMPLATE must be set for PR runs" >&2
              exit 1
            fi
          else
            if [ -n "${STAGING_URL:-}" ]; then
              target="${STAGING_URL}"
            else
              echo "STAGING_URL must be set for scheduled e2e runs" >&2
              exit 1
            fi
          fi
          echo "target_url=$target" >> "$GITHUB_OUTPUT"

      - name: Run happy path UI test
        run: |
          set -euo pipefail
          url="${{ steps.target.outputs.target_url }}"
          mkdir -p artifacts
          response_file=artifacts/response.html
          trace_file=artifacts/trace.txt
          http_status=$(curl --write-out '%{http_code}' --silent --show-error --output "$response_file" "$url") || {
            echo "curl failed for $url" >> "$trace_file"
            exit 1
          }
          if [ "$http_status" -ge 200 ] && [ "$http_status" -lt 400 ]; then
            echo "Happy path verified: HTTP $http_status" >> "$trace_file"
          else
            echo "Unexpected HTTP status $http_status" >> "$trace_file"
            exit 1
          fi

      - name: Upload diagnostics on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-diagnostics
          path: artifacts
