name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Publish release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install front-end dependencies & build
        run: |
          cd frontend
          npm ci
          npm run build

      - name: Package distribution
        run: |
          zip -r frontend-dist.zip frontend/dist

      - name: Generate checksums
        run: |
          sha256sum frontend-dist.zip > release-checksums.txt

      - name: Generate SBOM with Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /tmp/syft
          export PATH="/tmp/syft:$PATH"
          syft dir:frontend/dist -o json=release-sbom.json

      - name: Derive release notes
        id: release-notes
        run: |
          set -euo pipefail
          previous_tag=$(git describe --tags --abbrev=0 "${GITHUB_REF}^" 2>/dev/null || true)
          if [ -n "$previous_tag" ]; then
            range="${previous_tag}..${GITHUB_REF_NAME}"
            changelog=$(git log --no-merges --oneline "${previous_tag}..${GITHUB_SHA}")
          else
            range="initial..${GITHUB_REF_NAME}"
            changelog=$(git log --no-merges --oneline -n 20 "${GITHUB_SHA}")
          fi
          if [ -z "$changelog" ]; then
            changelog="- No new commits detected."
          fi
          cat <<'EOF' > release-notes.md
          ## Changes since $range

          $changelog

          EOF
          echo "release_notes<<'EOF'" >> "$GITHUB_OUTPUT"
          cat release-notes.md >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: ${{ steps.release-notes.outputs.release_notes }}
          files: |
            frontend-dist.zip
            release-sbom.json
            release-checksums.txt
