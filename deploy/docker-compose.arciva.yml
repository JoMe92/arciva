version: "3.9"

services:
  app:
    image: ${ARCIVA_IMAGE:-ghcr.io/arciva/arciva:latest}
    build:
      context: ..
      dockerfile: Dockerfile
    env_file:
      - .env.arciva
    environment:
      APP_ENV: ${APP_ENV:-prod}
      SECRET_KEY: ${SECRET_KEY}
      DATABASE_URL: ${DATABASE_URL}
      APP_DB_PATH: ${APP_DB_PATH:-/data/db/app.db}
      APP_MEDIA_ROOT: ${APP_MEDIA_ROOT:-/data/media}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      ALLOWED_ORIGINS__0: ${ALLOWED_ORIGINS__0:-http://localhost:8000}
      THUMB_SIZES: ${THUMB_SIZES:-[256]}
      MAX_UPLOAD_MB: ${MAX_UPLOAD_MB:-1000}
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-2}
      LOGS_DIR: ${LOGS_DIR:-/data/logs}
      PORT: ${APP_PORT:-8000}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "${APP_PORT:-8000}:8000"
    volumes:
      - /media/jome/data/arciva/media:/data/media
      - /media/jome/data/arciva/logs:/data/logs
      - /media/jome/data/arciva/db:/data/db
    restart: unless-stopped

  worker:
    image: ${ARCIVA_IMAGE:-ghcr.io/arciva/arciva:latest}
    build:
      context: ..
      dockerfile: Dockerfile
    command: [ "worker" ]
    env_file:
      - .env.arciva
    environment:
      APP_ENV: ${APP_ENV:-prod}
      SECRET_KEY: ${SECRET_KEY}
      DATABASE_URL: ${DATABASE_URL}
      APP_DB_PATH: ${APP_DB_PATH:-/data/db/app.db}
      APP_MEDIA_ROOT: ${APP_MEDIA_ROOT:-/data/media}
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}
      THUMB_SIZES: ${THUMB_SIZES:-[256]}
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-2}
      LOGS_DIR: ${LOGS_DIR:-/data/logs}
      OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4317
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    volumes:
      - /media/jome/data/arciva/media:/data/media
      - /media/jome/data/arciva/logs:/data/logs
      - /media/jome/data/arciva/db:/data/db
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    env_file:
      - .env.arciva
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-arciva}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-arciva}
      POSTGRES_DB: ${POSTGRES_DB:-arciva}
    volumes:
      - arciva_postgres:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-arciva}" ]
      interval: 10s
      timeout: 5s
      retries: 6
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: [ "redis-server", "--save", "60", "1", "--loglevel", "warning" ]
    restart: unless-stopped

  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"
      - "4317:4317"
      - "4318:4318"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    restart: unless-stopped

volumes:
  arciva_postgres:
